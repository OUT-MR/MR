import { useEffect, useMemo, useState } from "react";

type Product = {
  id: string;
  title: string;
  category: string;
  priceSek: number;
  image: string;
  description: string;
};

const PRODUCTS: Product[] = [
  {
    id: "tagliatelle-al-tartufo",
    title: "Tagliatelle al Tartufo",
    category: "Pasta",
    priceSek: 179,
    image:
      "https://images.unsplash.com/photo-1526318896980-cf78c088247c?auto=format&fit=crop&w=1600&q=80",
    description:
      "Kr√§mig tryffelpasta med rik smak. Perfekt f√∂r en lyxig middag.",
  },
  {
    id: "cacio-e-pepe",
    title: "Cacio e Pepe",
    category: "Pasta",
    priceSek: 149,
    image:
      "https://images.unsplash.com/photo-1546549032-9571cd6b27df?auto=format&fit=crop&w=1600&q=80",
    description:
      "Klassisk romersk pasta med pecorino och svartpeppar. Ren smak.",
  },
  {
    id: "vodka-pasta-burrata",
    title: "Vodka Pasta + burrata",
    category: "Pasta",
    priceSek: 189,
    image:
      "https://images.unsplash.com/photo-1525755662778-989d0524087e?auto=format&fit=crop&w=1600&q=80",
    description:
      "Tomat-vodkas√•s med burrata. Kr√§migt, syrligt, balanserat.",
  },
  {
    id: "kottbullar-2",
    title: "K√∂ttbullar 2.0",
    category: "Nordic",
    priceSek: 169,
    image:
      "https://images.unsplash.com/photo-1604909052601-0b67e5b22f84?auto=format&fit=crop&w=1600&q=80",
    description:
      "Nordiska k√∂ttbullar med uppgraderad smak och toppingval.",
  },
  {
    id: "biff-chimichurri",
    title: "Biff + chimichurri",
    category: "Nordic",
    priceSek: 219,
    image:
      "https://images.unsplash.com/photo-1551183053-bf91a1d81141?auto=format&fit=crop&w=1600&q=80",
    description:
      "Saftig biff med chimichurri. Enkel servering, stark upplevelse.",
  },
  {
    id: "poke-bowl",
    title: "Poke Bowl",
    category: "Sushi",
    priceSek: 179,
    image:
      "https://images.unsplash.com/photo-1543353071-087092ec393a?auto=format&fit=crop&w=1600&q=80",
    description:
      "Fr√§scha r√•varor, tydlig struktur. V√§lj protein och toppings.",
  },
];

const MODES = ["Duo", "Par", "Trio", "Squad", "Plato Mode"] as const;

export default function IndexPage() {
  const [scrolled, setScrolled] = useState(false);
  const [hovered, setHovered] = useState(false);

  const [menuOpen, setMenuOpen] = useState(false);
  const [searchOpen, setSearchOpen] = useState(false);

  const [view, setView] = useState<"home" | "product">("home");
  const [activeProduct, setActiveProduct] = useState<Product | null>(null);

  // sticky + scroll state
  useEffect(() => {
    const onScroll = () => setScrolled(window.scrollY > 10);
    onScroll();
    window.addEventListener("scroll", onScroll, { passive: true });
    return () => window.removeEventListener("scroll", onScroll);
  }, []);

  const isWhiteHeader = scrolled || hovered || menuOpen || searchOpen;

  const openProduct = (p: Product) => {
    setActiveProduct(p);
    setView("product");
    window.scrollTo({ top: 0, behavior: "instant" as ScrollBehavior });
  };

  const goHome = () => {
    setView("home");
    setActiveProduct(null);
    window.scrollTo({ top: 0, behavior: "instant" as ScrollBehavior });
  };

  return (
    <div className="min-h-screen bg-black text-white">
      <Header
        isWhite={isWhiteHeader}
        onHoverChange={setHovered}
        onOpenMenu={() => setMenuOpen(true)}
        onOpenSearch={() => setSearchOpen(true)}
        onLogoClick={goHome}
      />

      <MenuDrawer open={menuOpen} onClose={() => setMenuOpen(false)} />

      <SearchOverlay
        open={searchOpen}
        onClose={() => setSearchOpen(false)}
        items={PRODUCTS}
        onSelect={(p) => {
          setSearchOpen(false);
          openProduct(p);
        }}
      />

      {/* PAGE CONTENT */}
      {view === "home" ? (
        <Home
          products={PRODUCTS}
          onOpenProduct={openProduct}
          onOpenSearch={() => setSearchOpen(true)}
        />
      ) : (
        <ProductPage
          product={activeProduct}
          onBack={goHome}
          isWhiteHeader={isWhiteHeader}
        />
      )}

      <Footer />
    </div>
  );
}

/* ----------------------------- HEADER ----------------------------- */

function Header({
  isWhite,
  onHoverChange,
  onOpenMenu,
  onOpenSearch,
  onLogoClick,
}: {
  isWhite: boolean;
  onHoverChange: (v: boolean) => void;
  onOpenMenu: () => void;
  onOpenSearch: () => void;
  onLogoClick: () => void;
}) {
  const textClass = isWhite ? "text-black" : "text-white";
  const bgClass = isWhite ? "bg-white" : "bg-transparent";
  const borderClass = isWhite ? "border-black/10" : "border-white/10";

  return (
    <header
      onMouseEnter={() => onHoverChange(true)}
      onMouseLeave={() => onHoverChange(false)}
      className={[
        "fixed top-0 left-0 right-0 z-50",
        "transition-colors duration-200",
        bgClass,
        "backdrop-blur-sm",
        "border-b",
        borderClass,
      ].join(" ")}
    >
      <div className="h-16 px-4 sm:px-6 flex items-center justify-between">
        {/* LEFT */}
        <div className={["flex items-center gap-5", textClass].join(" ")}>
          <button
            onClick={onOpenMenu}
            className="flex items-center gap-2 text-sm"
            aria-label="Open menu"
          >
            <span className="text-xl leading-none">‚â°</span>
            <span className="hidden sm:inline">Menu</span>
          </button>

          <button
            onClick={onOpenSearch}
            className="flex items-center gap-2 text-sm"
            aria-label="Open search"
          >
            <span className="text-lg leading-none">‚åï</span>
            <span className="hidden sm:inline">Search</span>
          </button>
        </div>

        {/* CENTER LOGO */}
        <button
          onClick={onLogoClick}
          className={[
            "absolute left-1/2 -translate-x-1/2",
            "tracking-[0.35em] text-sm sm:text-base font-medium",
            textClass,
          ].join(" ")}
          aria-label="Go home"
        >
          BUILD A PLATE
        </button>

        {/* RIGHT */}
        <div className={["flex items-center gap-4", textClass].join(" ")}>
          <button className="text-sm hover:opacity-70" aria-label="Contact us">
            Contact us
          </button>

          <button className="p-2 rounded-full hover:bg-black/5" aria-label="Wishlist">
            ‚ô°
          </button>

          <button className="p-2 rounded-full hover:bg-black/5" aria-label="Login">
            ‚åÇ
          </button>

          <button className="relative p-2 rounded-full hover:bg-black/5" aria-label="Cart">
            üëú
            <span
              className={[
                "absolute -top-1 -right-1",
                "h-4 min-w-4 px-1 rounded-full text-[10px] grid place-items-center",
                isWhite ? "bg-black text-white" : "bg-white text-black",
              ].join(" ")}
            >
              0
            </span>
          </button>
        </div>
      </div>
    </header>
  );
}

/* ----------------------------- HOME ----------------------------- */

function Home({
  products,
  onOpenProduct,
  onOpenSearch,
}: {
  products: Product[];
  onOpenProduct: (p: Product) => void;
  onOpenSearch: () => void;
}) {
  return (
    <main className="pt-16">
      {/* HERO VIDEO */}
      <section className="relative h-[92vh] w-full overflow-hidden">
        <video
          className="absolute inset-0 h-full w-full object-cover"
          autoPlay
          muted
          loop
          playsInline
          poster="https://images.unsplash.com/photo-1529692236671-f1f6cf9683ba?auto=format&fit=crop&w=1600&q=80"
        >
          {/* Byt till din egen video */}
          <source
            src="https://cdn.coverr.co/videos/coverr-chef-prepares-a-dish-9728/1080p.mp4"
            type="video/mp4"
          />
        </video>

        <div className="absolute inset-0 bg-black/45" />

        <div className="absolute left-0 right-0 bottom-10 px-4 sm:px-10">
          <div className="max-w-6xl">
            <div className="text-xs tracking-[0.35em] text-white/70 uppercase">
              V√ÑSTMANLANDS L√ÑN
            </div>
            <h1 className="mt-3 text-4xl sm:text-6xl font-semibold">
              Bygg r√§tten. Tillsammans.
            </h1>

            {/* OBS: h√§r har vi INTE den meningen du ville ta bort */}
            <p className="mt-3 text-white/70 text-sm max-w-xl">
              Klicka en r√§tt f√∂r att v√§lja Duo, Par, Trio, Squad eller Plato Mode.
            </p>

            <div className="mt-6 flex gap-3">
              <button
                onClick={() => {
                  const el = document.getElementById("products");
                  el?.scrollIntoView({ behavior: "smooth" });
                }}
                className="rounded-full bg-white text-black px-5 py-2 text-sm hover:opacity-90"
              >
                Se r√§tter
              </button>

              <button
                onClick={onOpenSearch}
                className="rounded-full border border-white/40 px-5 py-2 text-sm hover:bg-white/10"
              >
                S√∂k
              </button>
            </div>
          </div>
        </div>
      </section>

      {/* FULLSCREEN IMAGES */}
      <FullBleedImage
        src="https://images.unsplash.com/photo-1526318896980-cf78c088247c?auto=format&fit=crop&w=2000&q=80"
        title="Seasonal drops"
        subtitle="Limited recipes. Full screen."
      />
      <FullBleedImage
        src="https://images.unsplash.com/photo-1543353071-087092ec393a?auto=format&fit=crop&w=2000&q=80"
        title="Texture first"
        subtitle="Clean layout. Strong product focus."
      />

      {/* PRODUCTS GRID (NO PRICES HERE) */}
      <section id="products" className="bg-white text-black">
        <div className="mx-auto max-w-6xl px-4 sm:px-6 py-14">
          <div className="flex items-end justify-between gap-4">
            <div>
              <div className="text-xs tracking-[0.3em] uppercase text-black/50">
                Build a plate
              </div>
              <h2 className="mt-2 text-2xl sm:text-3xl font-semibold">
                V√§lj en r√§tt
              </h2>
              <p className="mt-2 text-sm text-black/60 max-w-xl">
                Pris visas f√∂rst n√§r du √∂ppnar produkten.
              </p>
            </div>
          </div>

          <div className="mt-10 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {products.map((p) => (
              <button
                key={p.id}
                onClick={() => onOpenProduct(p)}
                className="text-left group"
              >
                <div className="aspect-[4/3] w-full overflow-hidden rounded-2xl bg-black/5">
                  <img
                    src={p.image}
                    alt={p.title}
                    className="h-full w-full object-cover transition-transform duration-300 group-hover:scale-[1.03]"
                  />
                </div>
                <div className="mt-4">
                  <div className="text-sm font-medium">{p.title}</div>
                  <div className="text-xs text-black/60 mt-1">{p.category}</div>
                  {/* INGET pris h√§r */}
                </div>
              </button>
            ))}
          </div>
        </div>
      </section>
    </main>
  );
}

function FullBleedImage({
  src,
  title,
  subtitle,
}: {
  src: string;
  title: string;
  subtitle: string;
}) {
  return (
    <section className="relative h-[92vh] w-full overflow-hidden">
      <img src={src} alt={title} className="absolute inset-0 h-full w-full object-cover" />
      <div className="absolute inset-0 bg-black/45" />
      <div className="absolute left-0 right-0 bottom-10 px-4 sm:px-10">
        <div className="max-w-6xl">
          <div className="text-xs tracking-[0.35em] text-white/70 uppercase">
            BUILD A PLATE
          </div>
          <h3 className="mt-3 text-3xl sm:text-5xl font-semibold">{title}</h3>
          <p className="mt-3 text-white/70 text-sm max-w-xl">{subtitle}</p>
        </div>
      </div>
    </section>
  );
}

/* ----------------------------- PRODUCT PAGE ----------------------------- */

function ProductPage({
  product,
  onBack,
}: {
  product: Product | null;
  onBack: () => void;
  isWhiteHeader: boolean;
}) {
  const [mode, setMode] = useState<(typeof MODES)[number]>("Duo");

  if (!product) {
    return (
      <main className="pt-16 bg-white text-black min-h-screen">
        <div className="mx-auto max-w-6xl px-4 sm:px-6 py-16">
          <button onClick={onBack} className="text-sm underline">
            Tillbaka
          </button>
          <div className="mt-6">Ingen produkt vald.</div>
        </div>
      </main>
    );
  }

  return (
    <main className="pt-16 bg-white text-black min-h-screen">
      <div className="mx-auto max-w-6xl px-4 sm:px-6 py-10">
        <button onClick={onBack} className="text-sm underline">
          Tillbaka
        </button>

        <div className="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-10">
          <div className="aspect-[4/3] rounded-2xl overflow-hidden bg-black/5">
            <img src={product.image} alt={product.title} className="h-full w-full object-cover" />
          </div>

          <div>
            <div className="text-xs tracking-[0.3em] uppercase text-black/50">
              {product.category}
            </div>
            <h1 className="mt-2 text-3xl sm:text-4xl font-semibold">
              {product.title}
            </h1>

            <div className="mt-4 text-black/70 text-sm leading-6">
              {product.description}
            </div>

            {/* PRICE ONLY HERE */}
            <div className="mt-6 text-xl font-semibold">
              {formatSEK(product.priceSek)}
            </div>

            {/* MODE SELECT */}
            <div className="mt-8">
              <div className="text-sm font-medium">V√§lj l√§ge</div>
              <div className="mt-3 flex flex-wrap gap-2">
                {MODES.map((m) => (
                  <button
                    key={m}
                    onClick={() => setMode(m)}
                    className={[
                      "rounded-full px-4 py-2 text-sm border transition",
                      mode === m
                        ? "border-black bg-black text-white"
                        : "border-black/20 hover:border-black/50",
                    ].join(" ")}
                  >
                    {m}
                  </button>
                ))}
              </div>
            </div>

            <div className="mt-8 flex gap-3">
              <button className="rounded-full bg-black text-white px-6 py-3 text-sm hover:opacity-90">
                L√§gg i varukorg
              </button>
              <button className="rounded-full border border-black/20 px-6 py-3 text-sm hover:border-black/50">
                Logga in
              </button>
            </div>

            <div className="mt-6 text-xs text-black/60">
              Vald: {mode}
            </div>
          </div>
        </div>
      </div>
    </main>
  );
}

/* ----------------------------- LEFT MENU DRAWER ----------------------------- */

function MenuDrawer({ open, onClose }: { open: boolean; onClose: () => void }) {
  useEffect(() => {
    if (!open) return;

    const onKey = (e: KeyboardEvent) => {
      if (e.key === "Escape") onClose();
    };
    document.addEventListener("keydown", onKey);

    const prev = document.body.style.overflow;
    document.body.style.overflow = "hidden";

    return () => {
      document.removeEventListener("keydown", onKey);
      document.body.style.overflow = prev;
    };
  }, [open, onClose]);

  return (
    <>
      {/* overlay */}
      <div
        onClick={onClose}
        className={[
          "fixed inset-0 z-[90] bg-black/40 transition-opacity duration-200",
          open ? "opacity-100 pointer-events-auto" : "opacity-0 pointer-events-none",
        ].join(" ")}
      />

      {/* drawer */}
      <div
        className={[
          "fixed top-0 left-0 z-[95] h-screen w-[86vw] max-w-[420px] bg-white text-black",
          "transition-transform duration-200",
          open ? "translate-x-0" : "-translate-x-full",
        ].join(" ")}
      >
        <div className="h-16 px-5 flex items-center justify-between border-b border-black/10">
          <div className="text-sm tracking-[0.3em] font-medium">MENU</div>
          <button onClick={onClose} className="p-2 rounded-full hover:bg-black/5" aria-label="Close menu">
            ‚úï
          </button>
        </div>

        <div className="p-6 space-y-4">
          <NavItem label="Nyheter" />
          <NavItem label="R√§tter" />
          <NavItem label="Plato Mode" />
          <NavItem label="Kontakt" />
          <div className="pt-4 border-t border-black/10">
            <NavItem label="Logga in" />
            <NavItem label="Varukorg" />
          </div>
        </div>
      </div>
    </>
  );
}

function NavItem({ label }: { label: string }) {
  return (
    <button className="w-full text-left text-sm py-2 hover:opacity-70">
      {label}
    </button>
  );
}

/* ----------------------------- SEARCH OVERLAY (LV STYLE) ----------------------------- */

function SearchOverlay({
  open,
  onClose,
  items,
  onSelect,
}: {
  open: boolean;
  onClose: () => void;
  items: Product[];
  onSelect: (p: Product) => void;
}) {
  const [q, setQ] = useState("");

  useEffect(() => {
    if (!open) return;

    const onKey = (e: KeyboardEvent) => {
      if (e.key === "Escape") onClose();
    };
    document.addEventListener("keydown", onKey);

    const prev = document.body.style.overflow;
    document.body.style.overflow = "hidden";

    return () => {
      document.removeEventListener("keydown", onKey);
      document.body.style.overflow = prev;
      setQ("");
    };
  }, [open, onClose]);

  const filtered = useMemo(() => {
    const s = q.trim().toLowerCase();
    if (!s) return items;
    return items.filter((x) =>
      (x.title + " " + x.category).toLowerCase().includes(s)
    );
  }, [q, items]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 z-[100] bg-white text-black">
      <div className="sticky top-0 bg-white">
        <div className="mx-auto max-w-6xl px-4 sm:px-6 pt-8">
          <div className="relative flex items-center justify-center">
            <div className="tracking-[0.35em] text-sm font-medium">
              BUILD A PLATE
            </div>

            <button
              onClick={onClose}
              className="absolute right-0 top-0 p-2 rounded-full hover:bg-black/5"
              aria-label="Close search"
            >
              ‚úï
            </button>
          </div>

          <div className="mt-6">
            <input
              autoFocus
              value={q}
              onChange={(e) => setQ(e.target.value)}
              placeholder="S√∂k r√§tt..."
              className="w-full rounded-full border border-black/20 px-6 py-4 text-base outline-none focus:border-black"
            />
          </div>

          <div className="mt-5 flex flex-wrap items-center gap-4 text-xs text-black/60">
            <span className="uppercase tracking-widest">Trending searches</span>
            {MODES.map((m) => (
              <button
                key={m}
                onClick={() => setQ(m)}
                className="hover:text-black"
              >
                {m}
              </button>
            ))}
          </div>

          <div className="mt-6 border-b border-black/10" />
        </div>
      </div>

      <div className="mx-auto max-w-6xl px-4 sm:px-6 py-10">
        <div className="text-xs text-black/60 mb-4">
          {filtered.length} tr√§ffar
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {filtered.map((p) => (
            <button
              key={p.id}
              onClick={() => onSelect(p)}
              className="text-left rounded-2xl border border-black/10 p-4 hover:border-black/30"
            >
              <div className="aspect-[4/3] rounded-xl overflow-hidden bg-black/5 mb-4">
                <img src={p.image} alt={p.title} className="h-full w-full object-cover" />
              </div>
              <div className="font-medium">{p.title}</div>
              <div className="text-sm text-black/60">{p.category}</div>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}

/* ----------------------------- FOOTER ----------------------------- */

function Footer() {
  return (
    <footer className="bg-black text-white/70">
      <div className="mx-auto max-w-6xl px-4 sm:px-6 py-12 text-sm">
        <div className="tracking-[0.35em] text-white/60 text-xs uppercase">
          BUILD A PLATE
        </div>
        <div className="mt-3">Contact us</div>
      </div>
    </footer>
  );
}

/* ----------------------------- HELPERS ----------------------------- */

function formatSEK(value: number) {
  return new Intl.NumberFormat("sv-SE", {
    style: "currency",
    currency: "SEK",
    maximumFractionDigits: 0,
  }).format(value);
}
